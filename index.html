<!DOCTYPE html>
<html lang="es">
<head>

    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/C5rPJZ8n/logo.png">
    <title>MusicPic - Music Chat Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1db954;
            --dark-bg: #121212;
            --darker-bg: #000000;
            --card-bg: #181818;
            --hover-bg: #282828;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: #333333;
        }

        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: var(--dark-bg);
          color: var(--text-primary);
          min-height: 100vh;
          overflow-x: hidden;
          overflow-y: auto;
        }

        /* Modal de Login */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-form {
        width: 100vw;
        min-width: 0;
        box-sizing: border-box;
        overflow-x: auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 32px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--hover-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
        }

        .color-picker {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option.selected {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary-color);
            color: var(--darker-bg);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn:hover {
            background: #1ed760;
            transform: translateY(-2px);
        }

        /* Modal de Subida */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .upload-form {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .upload-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .file-input-container {
            position: relative;
            cursor: pointer;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            transition: all 0.2s;
        }

        .file-input-container:hover {
            border-color: var(--primary-color);
            background: var(--hover-bg);
        }

        .file-input-container.active {
            border-color: var(--primary-color);
            background: rgba(29, 185, 84, 0.1);
        }

        .file-input-container input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-text {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .file-info {
            margin-top: 12px;
            padding: 12px;
            background: var(--hover-bg);
            border-radius: 8px;
            font-size: 14px;
        }

        .file-info strong {
            color: var(--primary-color);
        }

        .upload-progress {
            margin: 20px 0;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .upload-btn-submit {
            width: 100%;
            padding: 16px;
            background: var(--primary-color);
            color: var(--darker-bg);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn-submit:hover:not(:disabled) {
            background: #1ed760;
            transform: translateY(-2px);
        }

        .upload-btn-submit:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .app-container {
          display: flex;
          min-height: 100vh;
          flex-direction: row;
        }

        /* Barra Lateral */
        .sidebar {
            width: 240px;
            background: var(--darker-bg);
            padding: 24px 12px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            min-width: 200px;
            transition: left 0.3s, box-shadow 0.3s;
            position: relative;
        }

        /* Botón hamburguesa para móviles */
        .hamburger {
          display: none;
          position: fixed;
          top: 50%;
          left: 0;
          transform: translateY(-50%);
          z-index: 2001;
            width: 24px;
            height: 40px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0 8px 8px 0;
            box-shadow: 1px 0 4px rgba(0,0,0,0.10);
          cursor: pointer;
          align-items: center;
          justify-content: center;
          flex-direction: column;
          padding: 0;
          transition: left 0.3s, box-shadow 0.3s;
        }
        .hamburger span {
            display: block;
            width: 16px;
            height: 2px;
            background: var(--primary-color);
            margin: 4px auto;
            border-radius: 2px;
            transition: all 0.3s;
        }
        

        .logo-main {
  display: flex;
  align-items: center;
  /* opcional: espacio entre icono y texto */
  gap: 0.5rem;
}

.logo-main .logo-icon img {
  width: 40px;        /* ajusta según tu necesidad */
  height: auto;
  display: block;
}

.logo-main .logo-text {
  font-family: 'Arial', sans-serif;
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;        /* cambia color si lo necesitas */
  /* opcional: margenes, transformaciones, etc. */
}

        .nav-section h3 {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            padding: 0 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .nav-item:hover, .nav-item.active {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary-color);
            color: var(--darker-bg);
        }

        .user-selector {
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
        }

        .current-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 2px solid var(--primary-color);
        }

        .user-avatar-large {
            width: 48px;
            height: 48px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: var(--darker-bg);
        }

        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }

        /* Contenido Principal */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
            min-width: 0; /* Permite que se comprima */
        }

        .top-bar {
            height: 60px;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            border-bottom: 1px solid var(--border-color);
        }

        .view-tabs {
            display: flex;
            gap: 24px;
        }

        .tab {
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab.active {
            background: var(--primary-color);
            color: var(--darker-bg);
        }

        .tab:not(.active) {
            color: var(--text-secondary);
        }

        .tab:not(.active):hover {
            color: var(--text-primary);
            background: var(--hover-bg);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--darker-bg);
        }

        .content-area {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
            /* Altura calculada para dejar espacio al player */
            height: calc(100vh - 60px - 100px);
        }

        /* Vista de Música */
        .music-view {
            display: block;
        }

        .now-playing-card {
            background: linear-gradient(135deg, var(--card-bg), var(--hover-bg));
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .album-art {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .song-details {
            flex: 1;
            min-width: 0; /* Permite que el texto se truncue si es necesario */
        }

        .song-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .artist-name {
            font-size: 24px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .progress-container {
            margin-bottom: 16px;
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }

        .description {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .playlist-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
        }

        .library-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--primary-color);
            color: var(--darker-bg);
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: #1ed760;
            transform: translateY(-1px);
        }

        .song-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .loading-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
            font-style: italic;
        }

        .song-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .song-item:hover {
            background: var(--hover-bg);
        }

        .song-item.active {
            background: rgba(29, 185, 84, 0.1);
            border-left: 3px solid var(--primary-color);
        }

        .song-number {
            width: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            flex-shrink: 0;
        }

        .song-thumb {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            background: var(--hover-bg);
            overflow: hidden;
            flex-shrink: 0;
        }

        .song-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .song-info {
            flex: 1;
            min-width: 0;
        }

        .song-info .title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-info .artist {
            color: var(--text-secondary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-duration {
            color: var(--text-secondary);
            font-size: 14px;
            flex-shrink: 0;
        }

        .song-actions {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .song-item:hover .song-actions {
            opacity: 1;
        }

        .song-item:hover .song-duration {
            opacity: 0;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: var(--hover-bg);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--primary-color);
            color: var(--darker-bg);
        }

        .delete-btn:hover {
            background: #e74c3c;
            color: white;
        }

        /* Vista de Chat */
        .chat-view {
            display: none;
            flex-direction: column;
            height: calc(100vh - 160px); /* Ajustado para el player */

        }

        .chat-header {
            background: var(--card-bg);
            padding: 20px 24px;
            border-radius: 16px 16px 0 0;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .online-users {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .online-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            border-radius: 16px;
            background: var(--hover-bg);
        }

        .online-user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .online-user-name {
            font-size: 12px;
            color: var(--text-primary);
        }

        .chat-messages {
            flex: 1;
            padding: 20px 24px;
            overflow-y: auto;
            background: var(--card-bg);
        }

        .message {
            margin-bottom: 16px;
            max-width: 70%;
        }

        .message.sent {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .message-user {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .message-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .message-content {
            background: var(--hover-bg);
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            color: var(--darker-bg);
        }

        .chat-input-container {
            padding: 20px 24px;
            background: var(--card-bg);
            border-radius: 0 0 16px 16px;
            border-top: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
        }

        .chat-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            color: var(--text-primary);
            outline: none;
            min-width: 0;
        }

        .chat-input input:focus {
            border-color: var(--primary-color);
        }

        .input-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: var(--darker-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .input-btn:hover {
            transform: scale(1.05);
        }


/* RESPONSIVE DESIGN */

        /* Tablets (1024px y menos) */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .content-area {
                padding: 16px 24px;
            }
            
            .song-title {
                font-size: 36px;
            }
            
            .artist-name {
                font-size: 20px;
            }
            
            .now-playing-card {
                gap: 24px;
                padding: 24px;
            }
            
            .album-art {
                width: 160px;
                height: 160px;
            }
            
            .playlist-section {
                padding: 16px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .section-title {
                font-size: 20px;
            }
            
            .upload-btn {
                align-self: flex-end;
            }
            
            .song-item {
                gap: 12px;
                padding: 8px;
            }
            
            .song-thumb {
                width: 40px;
                height: 40px;
            }
            
            .song-info .title {
                font-size: 14px;
            }
            
            .song-info .artist {
                font-size: 12px;
            }
            
            .chat-view {
                height: calc(100vh - 180px);
                padding-bottom: 70px; /* Espacio para el player */
            }
            
            .chat-header {
                padding: 16px;
            }
            
            .chat-messages {
                padding: 16px;
            }
            
            .chat-input-container {
                padding: 16px;
            }
            
            .message {
                max-width: 85%;
            }
            
            /* Desktop Player Bar - Tablets */
            .desktop-player-bar {
                height: 80px;
                padding: 0 16px;
                gap: 16px;
            }
            
            .desktop-mini-player {
                min-width: 180px;
                gap: 12px;
            }
            
            .desktop-mini-album {
                width: 45px;
                height: 45px;
            }
            
            .desktop-title {
                font-size: 13px;
                max-width: 120px;
            }
            
            .desktop-artist {
                font-size: 11px;
                max-width: 120px;
            }
            
            .desktop-control-buttons {
                gap: 12px;
            }
            
            .desktop-control-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .desktop-play-btn {
                width: 36px;
                height: 36px;
            }
            
            .desktop-player-progress {
                max-width: 300px;
                gap: 8px;
            }
            
            .desktop-time {
                font-size: 10px;
                min-width: 32px;
            }
            
            .desktop-volume-section {
                min-width: 100px;
            }
            
            body:has(.desktop-player-bar[style*="flex"]) .content-area {
                height: calc(100vh - 60px - 80px);
            }
        }

        /* Mobile grande (768px y menos) */
        @media (max-width: 768px) {
            .desktop-player-bar {
                height: 70px;
                padding: 0 12px;
                gap: 12px;
            }
            
            .desktop-mini-player {
                min-width: 140px;
                gap: 10px;
            }
            
            .desktop-mini-album {
                width: 40px;
                height: 40px;
            }
            
            .desktop-title {
                font-size: 12px;
                max-width: 90px;
            }
            
            .desktop-artist {
                font-size: 10px;
                max-width: 90px;
            }
            
            .desktop-control-buttons {
                gap: 10px;
            }
            
            .desktop-control-btn {
                width: 26px;
                height: 26px;
                font-size: 11px;
            }
            
            .desktop-play-btn {
                width: 32px;
                height: 32px;
            }
            
            .desktop-player-progress {
                max-width: 220px;
                gap: 6px;
            }
            
            .desktop-time {
                font-size: 9px;
                min-width: 28px;
            }
            
            .desktop-volume-section {
                display: none !important;
            }
            
            body:has(.desktop-player-bar[style*="flex"]) .content-area {
                height: calc(100vh - 50px - 70px);
            }
        }

        /* Mobile pequeño (480px y menos) */
        @media (max-width: 480px) {
            .sidebar {
                position: fixed;
                left: -100vw;
                top: 0;
                height: 100vh;
                width: 80vw;
                max-width: 320px;
                min-width: 0;
                z-index: 2000;
                box-shadow: 2px 0 16px rgba(0,0,0,0.18);
                padding: 24px 12px;
                background: var(--darker-bg);
                transition: left 0.3s, box-shadow 0.3s;
            }
            
            .sidebar.open {
                left: 0;
            }

            /* Ocultar el top-bar en móviles */
            .top-bar {
                display: none;
            }
            
            .hamburger {
                display: flex;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .logo-text {
                font-size: 16px;
            }
            
            .view-tabs {
                gap: 12px;
            }
            
            .tab {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .user-info {
                gap: 8px;
            }
            
            .user-avatar {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .content-area {
                padding: 12px;
                height: calc(100vh - 64px);
            }
            
            .now-playing-card {
                padding: 16px;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .album-art {
                width: 100px;
                height: 100px;
            }
            
            .song-title {
                font-size: 20px;
            }
            
            .artist-name {
                font-size: 14px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .upload-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .input-btn {
                width: 32px;
                height: 32px;
            }
            
            /* Desktop Player Bar - Mobile */
            .desktop-player-bar {
                height: 64px;
                padding: 0 8px;
                gap: 8px;
            }
            
            .desktop-mini-player {
                min-width: 100px;
                gap: 8px;
            }
            
            .desktop-mini-album {
                width: 32px;
                height: 32px;
            }
            
            .desktop-mini-info {
                max-width: 70px;
            }
            
            .desktop-title {
                font-size: 11px;
                max-width: 70px;
            }
            
            .desktop-artist {
                font-size: 9px;
                max-width: 70px;
            }
            
            .desktop-player-controls {
                gap: 6px;
            }
            
            .desktop-control-buttons {
                gap: 8px;
            }
            
            .desktop-control-btn {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .desktop-play-btn {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }
            
            .desktop-player-progress {
                max-width: 140px;
                gap: 4px;
            }
            
            .desktop-time {
                font-size: 8px;
                min-width: 24px;
            }
            
            .progress-bar {
                height: 3px;
            }
            
            /* Ajustar chat-view sin el top-bar */
            .chat-view {
                height: calc(100vh - 64px);
            }
            
            /* Si hay player activo, ajustar las alturas */
            body:has(.desktop-player-bar[style*="flex"]) .content-area {
                height: calc(100vh - 64px);
            }
            
            body:has(.desktop-player-bar[style*="flex"]) .chat-view {
                height: calc(100vh - 64px);
            }
        }

        /* Mobile muy pequeño (360px y menos) */
        @media (max-width: 360px) {
            .top-bar {
                display: none;
            }
            
            .content-area {
                height: calc(100vh - 60px);
            }
            
            .chat-view {
                height: calc(100vh - 60px);
            }
            
            .desktop-player-bar {
                height: 60px;
                padding: 0 6px;
                gap: 6px;
            }
            
            .desktop-mini-album {
                width: 28px;
                height: 28px;
            }
            
            .desktop-mini-info {
                max-width: 60px;
            }
            
            .desktop-title {
                font-size: 10px;
                max-width: 60px;
            }
            
            .desktop-artist {
                font-size: 8px;
                max-width: 60px;
            }
            
            .desktop-control-btn {
                width: 22px;
                height: 22px;
                font-size: 9px;
            }
            
            .desktop-play-btn {
                width: 26px;
                height: 26px;
                font-size: 10px;
            }
            
            .desktop-player-progress {
                max-width: 100px;
                gap: 3px;
            }
            
            .desktop-time {
                font-size: 7px;
                min-width: 20px;
            }
        }

        /* DESKTOP PLAYER BAR - Diseño compacto */

        /* DESKTOP PLAYER BAR - Diseño compacto */
        .desktop-player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 90px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 24px;
            z-index: 1000;
        }

        .desktop-mini-player {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 180px;
            flex-shrink: 0;
        }

        .desktop-mini-album {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--hover-bg);
            flex-shrink: 0;
        }

        .desktop-mini-album img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .desktop-mini-info {
            flex: 1;
            min-width: 0;
        }

        .desktop-title {
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .desktop-artist {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .desktop-player-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }

        .desktop-control-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .desktop-control-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .desktop-control-btn:hover {
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .desktop-play-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: var(--darker-bg);
            font-size: 14px;
        }

        .desktop-play-btn:hover {
            background: #1ed760;
            transform: scale(1.05);
        }

        .desktop-player-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            max-width: 500px;
        }

        .desktop-time {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 35px;
            text-align: center;
            flex-shrink: 0;
        }

        .desktop-volume-section {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .desktop-volume-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            flex-shrink: 0;
        }

        /* RESPONSIVE MEDIA QUERIES */

        /* Tablets */
        @media (max-width: 1024px) {
            .desktop-player-bar {
                height: 80px;
                padding: 0 16px;
                gap: 16px;
            }
            
            .desktop-mini-player {
                min-width: 150px;
            }
            
            .desktop-mini-album {
                width: 45px;
                height: 45px;
            }
            
            .desktop-title {
                font-size: 13px;
            }
            
            .desktop-artist {
                font-size: 11px;
            }
            
            .desktop-control-btn {
                width: 28px;
                height: 28px;
            }
            
            .desktop-play-btn {
                width: 36px;
                height: 36px;
            }
            
            .desktop-player-progress {
                max-width: 350px;
            }
            
            body:has(.desktop-player-bar[style*="flex"]) .content-area {
                height: calc(100vh - 60px - 80px);
            }
        }

        /* Tablets pequeñas y móviles grandes */
        @media (max-width: 768px) {
            .desktop-player-bar {
                height: 70px;
                padding: 0 12px;
                gap: 12px;
            }
            
            .desktop-mini-player {
                min-width: 120px;
            }
            
            .desktop-mini-album {
                width: 40px;
                height: 40px;
            }
            
            .desktop-title {
                font-size: 12px;
            }
            
            .desktop-artist {
                font-size: 10px;
            }
            
            .desktop-control-buttons {
                gap: 12px;
            }
            
            .desktop-control-btn {
                width: 26px;
                height: 26px;
            }
            
            .desktop-play-btn {
                width: 32px;
                height: 32px;
            }
            
            .desktop-player-progress {
                max-width: 250px;
                gap: 6px;
            }
            
            .desktop-time {
                font-size: 10px;
                min-width: 30px;
            }
            
            .desktop-volume-section {
                display: none;
            }
            
            body:has(.desktop-player-bar[style*="flex"]) .content-area {
                height: calc(100vh - 50px - 70px);
            }
        }

        /* Móviles */
        @media (max-width: 480px) {
            .desktop-player-bar {
                height: 56px;
                padding: 0 8px;
                gap: 8px;
            }
            
            .desktop-mini-player {
                min-width: 80px;
                gap: 8px;
            }
            
            .desktop-mini-album {
                width: 36px;
                height: 36px;
            }
            
            .desktop-mini-info {
                max-width: 50px;
            }
            
            .desktop-title {
                font-size: 10px;
            }
            
            .desktop-artist {
                font-size: 8px;
            }
            
            .desktop-player-controls {
                gap: 4px;
            }
            
            .desktop-control-buttons {
                gap: 8px;
            }
            
            .desktop-control-btn {
                width: 22px;
                height: 22px;
                font-size: 10px;
            }
            
            .desktop-play-btn {
                width: 26px;
                height: 26px;
                font-size: 11px;
            }
            
            .desktop-player-progress {
                max-width: 150px;
                gap: 4px;
            }
            
            .desktop-time {
                font-size: 8px;
                min-width: 24px;
            }
            
            .progress-bar {
                height: 2px;
            }
            
            body:has(.desktop-player-bar[style*="flex"]) .content-area {
                height: calc(100vh - 50px - 56px);
            }
            
            .chat-view {
                height: calc(100vh - 50px - 64px);
                padding-bottom: 60px; /* Espacio para el player */
            }
            
            /* Hacer el now-playing-card más compacto */
            .now-playing-card {
                flex-direction: column;
                padding: 12px;
                gap: 12px;
                align-items: center;
                text-align: center;
            }
            
            .album-art {
                width: 80px;
                height: 80px;
            }
        }

        /* Móviles muy pequeños */
        @media (max-width: 360px) {
            .desktop-player-bar {
                height: 52px;
                padding: 0 6px;
                gap: 6px;
            }
            
            .desktop-mini-player {
                min-width: 70px;
                gap: 6px;
            }
            
            .desktop-mini-album {
                width: 32px;
                height: 32px;
            }
            
            .desktop-mini-info {
                max-width: 40px;
            }
            
            .desktop-title {
                font-size: 9px;
            }
            
            .desktop-artist {
                font-size: 7px;
            }
            
            .desktop-control-btn {
                width: 20px;
                height: 20px;
                font-size: 9px;
            }
            
            .desktop-play-btn {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .desktop-player-progress {
                max-width: 100px;
                gap: 2px;
            }
            
            .desktop-time {
                font-size: 7px;
                min-width: 20px;
            }
        }

        /* Landscape orientation fixes */
        @media (orientation: landscape) and (max-height: 600px) {
            .content-area {
                height: calc(100vh - 140px);
            }
            
            .chat-view {
                height: calc(100vh - 140px);
            }
            
            .desktop-player-bar {
                height: 60px;
            }
            
            .now-playing-card {
                padding: 16px;
            }
            
            .album-art {
                width: 120px;
                height: 120px;
            }
            
            .song-title {
                font-size: 28px;
            }
        }

        /* Fix for very wide screens */
        @media (min-width: 1440px) {
            .content-area {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
        
        /* Fix for very wide screens */
        @media (min-width: 1440px) {
            .content-area {
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .player-bar {
                max-width: 1200px;
                margin: 0 auto;
                width: 100%;
            }
        }
        
        /* Landscape orientation fixes */
        @media (orientation: landscape) and (max-height: 600px) {
            .content-area {
                height: calc(100vh - 140px);
            }
            
            .chat-view {
                height: calc(100vh - 140px);
            }
            
            .player-bar {
                height: 70px;
            }
            
            .now-playing-card {
                padding: 16px;
            }
            
            .album-art {
                width: 120px;
                height: 120px;
            }
            
            .song-title {
                font-size: 28px;
            }
        }
        
        /* Print styles */
        @media print {
            .player-bar,
            .sidebar,
            .top-bar {
                display: none !important;
            }
            
            .main-content {
                width: 100% !important;
                height: auto !important;
            }
            
            .content-area {
                height: auto !important;
                overflow: visible !important;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #666666;
                --text-secondary: #cccccc;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus styles for accessibility */
        .control-btn:focus,
        .input-btn:focus,
        .upload-btn:focus,
        .login-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        .form-input:focus,
        .chat-input input:focus {
            box-shadow: 0 0 0 2px var(--primary-color);
        }



        /* DESKTOP PLAYER BAR - NUEVO */
        .desktop-player-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 90px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 24px;
            z-index: 1000;
        }

        .desktop-mini-player {
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 250px;
        }

        .desktop-mini-album {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--hover-bg);
        }

        .desktop-mini-album img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .desktop-mini-info {
            flex: 1;
        }

        .desktop-title {
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .desktop-artist {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .desktop-player-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .desktop-control-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .desktop-control-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .desktop-control-btn:hover {
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .desktop-play-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: var(--darker-bg);
            font-size: 14px;
        }

        .desktop-play-btn:hover {
            background: #1ed760;
            transform: scale(1.05);
        }

        .desktop-player-progress {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            max-width: 400px;
        }

        .desktop-time {
            font-size: 11px;
            color: var(--text-secondary);
            min-width: 35px;
            text-align: center;
        }

        .desktop-volume-section {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .desktop-volume-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
        }

        /* Ajustar content-area para el nuevo player */
        body:has(.desktop-player-bar[style*="flex"]) .content-area {
            height: calc(100vh - 60px - 90px);
        }
    </style>
    <meta name="google-site-verification" content="lsoHl8wlmbPpomqEMPnlVbXy8BC8LSJQXOI0lMglTJI" />
</head>
<body>
    <!-- Botón hamburguesa tipo pestaña vertical centrada a la izquierda -->
    <button class="hamburger" id="hamburgerBtn" aria-label="Abrir menú">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2 class="login-title">Welcome to MusicPic</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Choose your nickname</label>
                    <input type="text" class="form-input" id="nicknameInput" placeholder="Enter your nickname" maxlength="20" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Pick your color</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option selected" data-color="#1db954" style="background: #1db954;"></div>
                        <div class="color-option" data-color="#ff6b6b" style="background: #ff6b6b;"></div>
                        <div class="color-option" data-color="#4ecdc4" style="background: #4ecdc4;"></div>
                        <div class="color-option" data-color="#45b7d1" style="background: #45b7d1;"></div>
                        <div class="color-option" data-color="#f9ca24" style="background: #f9ca24;"></div>
                        <div class="color-option" data-color="#f0932b" style="background: #f0932b;"></div>
                        <div class="color-option" data-color="#eb4d4b" style="background: #eb4d4b;"></div>
                        <div class="color-option" data-color="#6c5ce7" style="background: #6c5ce7;"></div>
                        <div class="color-option" data-color="#a29bfe" style="background: #a29bfe;"></div>
                        <div class="color-option" data-color="#fd79a8" style="background: #fd79a8;"></div>
                        <div class="color-option" data-color="#00b894" style="background: #00b894;"></div>
                        <div class="color-option" data-color="#00cec9" style="background: #00cec9;"></div>
                    </div>
                </div>
                <button type="submit" class="login-btn">Join MusicPic</button>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar">
<div class="logo-main">
                <div class="logo-icon">
                    <img src="https://i.postimg.cc/C5rPJZ8n/logo.png" alt="Logo MusicPic" />
                </div>
                <div class="logo-text">MusicPic</div>
            </div>

            <div class="nav-section">
                <h3>Menu</h3>
                <div class="nav-item active" onclick="showView('music')">
                    <span>🏠</span>
                    <span>Home</span>
                </div>
                <div class="nav-item" onclick="showView('chat')">
                    <span>💬</span>
                    <span>Music Chat</span>
                </div>
                
            </div>

            <div class="user-selector">
                <div class="current-user">
                    <div class="user-avatar-large" id="currentUserAvatar"></div>
                    <div class="user-name" id="currentUserName"></div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div class="view-tabs">
                    <div class="tab active" onclick="showView('music')">Music</div>
                    <div class="tab" onclick="showView('chat')">Chat</div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="topUserAvatar"></div>
                    <span id="topUserName"></span>
                </div>
            </div>

            <div class="content-area">
                <!-- Music View -->
                <div class="music-view" id="musicView">
                    <div class="now-playing-card">
                        <div class="album-art" id="albumArt">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23333'/%3E%3Ctext x='100' y='100' text-anchor='middle' dy='0.35em' font-family='Arial' font-size='20' fill='%23999'%3ESelect a song%3C/text%3E%3C/svg%3E" alt="Album Art" id="albumImage">
                        </div>
                        <div class="song-details">
                            <div class="song-title" id="songTitle">Select a song</div>
                            <div class="artist-name" id="artistName">Artist</div>
                            <div class="progress-container">
                                <div class="time-row">
                                    <span id="currentTime">0:00</span>
                                    <span id="duration">0:00</span>
                                </div>
                                <div class="progress-bar" onclick="seekTo(event)">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                            </div>
                            <div class="description" id="description">
                                Song description will appear here...
                            </div>
                        </div>
                    </div>

                    <div class="playlist-section">
                        <div class="section-header">
                            <h2 class="section-title">Music Library</h2>
                            <div class="library-controls">
                                <button class="upload-btn" onclick="loadMusicLibrary()" title="Refresh from GitHub">
                                    <span>🔄</span>
                                    <span>Refresh</span>
                                </button>
                            </div>
                        </div>
                        <div class="song-list" id="songList">
                            <div class="loading-message" id="libraryLoading">Loading music library from GitHub...</div>
                        </div>
                    </div>
                </div>

                <!-- Chat View -->
                <div class="chat-view" id="chatView">
                    <div class="chat-header">
                        <div class="chat-title">Music Chat</div>
                        <div class="online-users" id="onlineUsers"></div>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="Write a message..." onkeypress="handleKeyPress(event)">
                            <button class="input-btn" onclick="shareCurrentSong()">🎵</button>
                            <button class="input-btn" onclick="sendMessage()">➤</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Desktop Player Bar - Aparece solo cuando hay canción seleccionada -->
        <div class="desktop-player-bar" id="desktopPlayerBar" style="display: none;">
            <div class="desktop-mini-player">
                <div class="desktop-mini-album">
                    <img src="" alt="Album" id="desktopMiniAlbum">
                </div>
                <div class="desktop-mini-info">
                    <div class="desktop-title" id="desktopMiniTitle">-</div>
                    <div class="desktop-artist" id="desktopMiniArtist">-</div>
                </div>
            </div>

            <div class="desktop-player-controls">
                <div class="desktop-control-buttons">
                    <button class="desktop-control-btn" onclick="previousSong()">⏮</button>
                    <button class="desktop-control-btn desktop-play-btn" id="desktopPlayBtn" onclick="togglePlayPause()">▶</button>
                    <button class="desktop-control-btn" onclick="nextSong()">⏭</button>
                </div>
                <div class="desktop-player-progress">
                    <span class="desktop-time" id="desktopCurrentTime">0:00</span>
                    <div class="progress-bar" onclick="seekTo(event)">
                        <div class="progress-fill" id="desktopProgressFill"></div>
                    </div>
                    <span class="desktop-time" id="desktopDuration">0:00</span>
                </div>
            </div>

            <div class="desktop-volume-section">
                <button class="desktop-volume-btn" onclick="toggleMute()">🔊</button>
                <div class="volume-slider" onclick="setVolume(event)">
                    <div class="volume-fill" id="desktopVolumeFill"></div>
                </div>
            </div>
        </div>

    <script>
        // Hamburguesa para mostrar/ocultar sidebar en móviles
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebar = document.querySelector('.sidebar');
        hamburgerBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });
        // Cerrar sidebar al hacer click fuera en móviles
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 480) {
                if (!sidebar.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });
        // Supabase configuration
        const SUPABASE_URL = 'https://pmdicldnsufqekqzcean.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZGljbGRuc3VmcWVrcXpjZWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwOTQ0NzEsImV4cCI6MjA3NDY3MDQ3MX0.dFNdE1yRi5JP0OOnY5eUirO45Ke7Lsq73BkTeY-hPpQ';
        
        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // GitHub configuration for music storage
        const GITHUB_REPO = 'Avidrift/musicpic';
        const MUSIC_FOLDER = 'music';
        const GITHUB_RAW_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${MUSIC_FOLDER}`;

        // Global variables
        let currentUser = null;
        let musicLibrary = [];
        let currentSongIndex = null;
        let isPlaying = false;
        let audio = new Audio();
        let messagesSubscription = null;
        let usersSubscription = null;

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const appContainer = document.getElementById('appContainer');
        const playerBar = document.getElementById('playerBar');
        const loginForm = document.getElementById('loginForm');
        const nicknameInput = document.getElementById('nicknameInput');
        const colorPicker = document.getElementById('colorPicker');
        const musicView = document.getElementById('musicView');
        const chatView = document.getElementById('chatView');
        const songList = document.getElementById('songList');
        const chatMessages = document.getElementById('chatMessages');
        const onlineUsers = document.getElementById('onlineUsers');
        const messageInput = document.getElementById('messageInput');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing MusicPic...');
            setupColorPicker();
            setupLoginForm();
            loadMusicFiles();
        });

        // Setup color picker functionality
        function setupColorPicker() {
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        }

        // Setup login form
        function setupLoginForm() {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleLogin();
            });
        }


        // Handle user login
        async function handleLogin() {
            console.log('=== STARTING LOGIN ===');
            const nickname = nicknameInput.value.trim();
            const selectedColorElement = document.querySelector('.color-option.selected');
            
            console.log('Nickname:', nickname);
            console.log('Selected color element:', selectedColorElement);
            
            if (!selectedColorElement) {
                alert('Please select a color');
                return;
            }
            
            const selectedColor = selectedColorElement.dataset.color;
            console.log('Selected color:', selectedColor);

            if (!nickname) {
                alert('Please enter a nickname');
                return;
            }

            if (nickname.length < 2) {
                alert('Nickname must be at least 2 characters long');
                return;
            }

            try {
                console.log('Checking if nickname already exists...');
                // Verificar si el nickname ya existe
                const { data: existingUser, error: checkError } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('nickname', nickname)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('Error checking existing user:', checkError);
                    throw checkError;
                }

                let user;
                
                if (existingUser) {
                    // Usuario existe - actualizar color y marcar como online
                    console.log('User exists, updating color and status...');
                    const { data: updatedUser, error: updateError } = await supabaseClient
                        .from('users')
                        .update({
                            color: selectedColor,
                            is_online: true,
                            last_seen: new Date().toISOString()
                        })
                        .eq('id', existingUser.id)
                        .select()
                        .single();

                    if (updateError) {
                        console.error('Error updating user:', updateError);
                        throw updateError;
                    }
                    
                    user = updatedUser;
                    console.log('User updated successfully:', user);
                } else {
                    // Usuario nuevo - crear
                    console.log('Nickname available, creating new user...');
                    const { data: newUser, error: createError } = await supabaseClient
                        .from('users')
                        .insert({
                            nickname: nickname,
                            color: selectedColor,
                            is_online: true
                        })
                        .select()
                        .single();

                    if (createError) {
                        console.error('Error creating user:', createError);
                        throw createError;
                    }
                    
                    user = newUser;
                    console.log('User created successfully:', user);
                }

                currentUser = user;
                updateUserTheme(selectedColor);
                initializeApp();

            } catch (error) {
                console.error('Login error:', error);
                alert('Error logging in: ' + (error.message || 'Please check your Supabase configuration'));
            }
        }
        // Update user theme with selected color
        function updateUserTheme(color) {
            console.log('Updating user theme with color:', color);
            document.documentElement.style.setProperty('--primary-color', color);
            
            // Update user avatars
            const avatars = [
                document.getElementById('currentUserAvatar'),
                document.getElementById('topUserAvatar')
            ];
            
            avatars.forEach(avatar => {
                if (avatar) {
                    avatar.style.backgroundColor = color;
                    avatar.textContent = currentUser.nickname[0].toUpperCase();
                }
            });

            // Update user names
            const nameElements = [
                document.getElementById('currentUserName'),
                document.getElementById('topUserName')
            ];
            
            nameElements.forEach(elem => {
                if (elem) elem.textContent = currentUser.nickname;
            });
        }

        // Initialize the main application
        function initializeApp() {
            console.log('Initializing main application...');
            loginModal.style.display = 'none';
            appContainer.style.display = 'flex';
            // NO tocar la línea del playerBar, dejar que el CSS lo maneje
            
            setupRealtimeSubscriptions();
            loadOnlineUsers();
            loadMessages();
            showView('music');

            // Auto refresh every 5 seconds
            setInterval(() => {
                console.log('⏳ Auto refresh executed');
                loadOnlineUsers();
                loadMessages();
            }, 5000);

            console.log('Application initialized correctly');
        }

        // Setup realtime subscriptions
        function setupRealtimeSubscriptions() {
            console.log('Setting up realtime subscriptions...');
            try {
                // Subscribe to new messages
                messagesSubscription = supabaseClient
                    .channel('messages')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'messages'
                    }, (payload) => {
                        console.log('New message received:', payload);
                        displayMessage(payload.new);
                    })
                    .subscribe();

                // Subscribe to user changes
                usersSubscription = supabaseClient
                    .channel('users')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'users'
                    }, () => {
                        console.log('User change detected');
                        loadOnlineUsers();
                    })
                    .subscribe();
            } catch (error) {
                console.warn('Realtime subscriptions failed, using manual refresh mode:', error);
                setupManualRefresh();
            }
        }

        // Setup manual refresh as fallback
        function setupManualRefresh() {
            console.log('Setting up manual refresh every 5 seconds...');
            setInterval(() => {
                if (document.querySelector('#chatView').style.display === 'flex') {
                    loadMessages();
                    loadOnlineUsers();
                }
            }, 5000);
        }

        // Load online users
        async function loadOnlineUsers() {
            console.log('Loading online users...');
            try {
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('is_online', true)
                    .order('created_at');

                if (error) {
                    console.error('Error loading users:', error);
                    return;
                }

                console.log('Users loaded:', users);
                displayOnlineUsers(users || []);
            } catch (error) {
                console.error('Error loading online users:', error);
            }
        }

        // Display online users
        function displayOnlineUsers(users) {
            onlineUsers.innerHTML = '';
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'online-user';
                userElement.innerHTML = `
                    <div class="online-user-avatar" style="background-color: ${user.color}; color: #000;">
                        ${user.nickname[0].toUpperCase()}
                    </div>
                    <div class="online-user-name">${user.nickname}</div>
                `;
                onlineUsers.appendChild(userElement);
            });
        }

        // Load chat messages
        async function loadMessages() {
            console.log('Loading chat messages...');
            try {
                const { data: messages, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        users (nickname, color)
                    `)
                    .order('created_at')
                    .limit(50);

                if (error) {
                    console.error('Error loading messages:', error);
                    return;
                }

                console.log('Messages loaded:', messages);
                chatMessages.innerHTML = '';
                messages?.forEach(message => displayMessage(message));
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display a message in the chat
        function displayMessage(message) {
            console.log('Displaying message:', message);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const isOwnMessage = message.user_id === currentUser?.id;
            if (isOwnMessage) messageDiv.classList.add('sent');

            // Handle user data - it might come from different sources
            let user;
            if (message.users) {
                user = message.users;
            } else {
                // Fallback for realtime messages
                user = { nickname: 'User', color: '#999999' };
            }
            
            const time = new Date(message.created_at).toLocaleTimeString([], {
                hour: '2-digit', 
                minute: '2-digit'
            });

            let messageContent = message.content;
            if (message.message_type === 'music_share' && message.metadata) {
                messageContent = `🎵 Now playing: ${message.metadata.title} by ${message.metadata.artist}`;
            }

            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar" style="background-color: ${user.color}; color: #000;">
                        ${user.nickname[0].toUpperCase()}
                    </div>
                    <div class="message-user">${user.nickname}</div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content" ${isOwnMessage ? `style="background-color: ${user.color};"` : ''}>
                    ${messageContent}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send a message
        async function sendMessage() {
            console.log('=== SEND MESSAGE FUNCTION CALLED ===');
            
            // Basic diagnostics
            console.log('Current user:', currentUser);
            console.log('Message input element:', messageInput);
            console.log('Supabase client:', supabaseClient);
            
            if (!currentUser) {
                console.error('ERROR: No user logged in');
                alert('Error: No user logged in');
                return;
            }
            
            if (!messageInput) {
                console.error('ERROR: Message input element not found');
                alert('Error: Message input not found');
                return;
            }
            
            const content = messageInput.value.trim();
            console.log('Message content:', content);
            
            if (!content) {
                console.log('Cannot send: empty message');
                return;
            }

            console.log('Attempting to send message:', content);

            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert({
                        user_id: currentUser.id,
                        content: content,
                        message_type: 'text'
                    })
                    .select();

                if (error) {
                    console.error('Error sending message:', error);
                    alert('Error sending message: ' + error.message);
                    return;
                }

                console.log('Message sent successfully:', data);
                messageInput.value = '';
                
                // Reload messages to show the new message
                setTimeout(() => {
                    loadMessages();
                }, 500);
                
            } catch (error) {
                console.error('Network error sending message:', error);
                alert('Network error sending message: ' + error.message);
            }
        }

        // Share current song
        async function shareCurrentSong() {
            console.log('=== SHARE SONG ===');
            if (!currentUser || currentSongIndex === null) {
                console.log('Cannot share: no user or selected song');
                return;
            }

            const currentSong = musicLibrary[currentSongIndex];
            if (!currentSong) {
                console.log('Cannot share: no current song data');
                return;
            }

            console.log('Sharing song:', currentSong);

            try {
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert({
                        user_id: currentUser.id,
                        content: `Sharing: ${currentSong.title} by ${currentSong.artist}`,
                        message_type: 'music_share',
                        metadata: {
                            title: currentSong.title,
                            artist: currentSong.artist
                        }
                    })
                    .select();

                if (error) {
                    console.error('Error sharing song:', error);
                    alert('Error sharing song: ' + error.message);
                    return;
                }

                console.log('Song shared successfully:', data);
                
                // Reload messages to show the new message
                setTimeout(() => {
                    loadMessages();
                }, 500);
                
            } catch (error) {
                console.error('Network error sharing song:', error);
                alert('Network error sharing song: ' + error.message);
            }
        }

        // Handle key press in message input
        function handleKeyPress(event) {
            console.log('Key pressed:', event.key);
            if (event.key === 'Enter') {
                console.log('Enter detected, calling sendMessage()');
                sendMessage();
            }
        }

        // Load music library from GitHub
        async function loadMusicLibrary() {
            console.log('Loading music library from GitHub...');
            document.getElementById('libraryLoading').style.display = 'block';
            
            try {
                // Get list of files from GitHub API
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${MUSIC_FOLDER}`);
                const files = await response.json();
                
                if (!Array.isArray(files)) {
                    throw new Error('Failed to load music files from GitHub');
                }
                
                // Filter audio files
                const audioFiles = files.filter(file => 
                    file.name.match(/\.(mp3|wav|ogg|m4a)$/i) && file.type === 'file'
                );
                
                // Process files into songs
                musicLibrary = audioFiles.map((file, index) => {
                    const fileName = file.name.replace(/\.[^/.]+$/, "");
                    
                    // Try to parse "Artist - Title" format
                    let title = fileName;
                    let artist = 'Unknown Artist';
                    
                    if (fileName.includes(' - ')) {
                        const parts = fileName.split(' - ');
                        artist = parts[0].trim();
                        title = parts.slice(1).join(' - ').trim();
                    }
                    
                    return {
                        id: index + 1,
                        title: title,
                        artist: artist,
                        duration: '0:00',
                        description: `Audio file: ${file.name}`,
                        audioSrc: `${GITHUB_RAW_URL}/${file.name}`,
                        albumArt: `https://via.placeholder.com/200x200/333/999?text=${encodeURIComponent(title)}`,
                        uploadedBy: null, // GitHub files don't have user ownership
                        createdAt: new Date().toISOString(),
                        filePath: file.name
                    };
                });
                
                console.log('Processed music library:', musicLibrary);
                renderSongList();
                document.getElementById('libraryLoading').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading music from GitHub:', error);
                document.getElementById('libraryLoading').innerHTML = 
                    '<div style="color: #e74c3c;">Error loading music library from GitHub. Check console for details.</div>';
            }
        }

        // Load music files (now loads from GitHub)
        function loadMusicFiles() {
            loadMusicLibrary();
        }

        // Render song list
        function renderSongList() {
            songList.innerHTML = '';
            
            if (musicLibrary.length === 0) {
                songList.innerHTML = '<div class="loading-message">No songs found in GitHub repository. Check your repo configuration.</div>';
                return;
            }

            musicLibrary.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.classList.add('song-item');
                if (index === currentSongIndex) {
                    songItem.classList.add('active');
                }
                
                songItem.innerHTML = `
                    <div class="song-number">${index + 1}</div>
                    <div class="song-thumb">
                        <img src="${song.albumArt}" alt="${song.title}">
                    </div>
                    <div class="song-info">
                        <div class="title">${song.title}</div>
                        <div class="artist">${song.artist}</div>
                    </div>
                    <div class="song-duration">${song.duration}</div>
                `;
                
                songItem.onclick = () => selectSong(index);
                songList.appendChild(songItem);
            });
        }

        // Music player functions
        function selectSong(index) {
            if (musicLibrary[index]) {
                currentSongIndex = index;
                const song = musicLibrary[index];
                
                // Update displays originales
                document.getElementById('albumImage').src = song.albumArt;
                document.getElementById('songTitle').textContent = song.title;
                document.getElementById('artistName').textContent = song.artist;
                document.getElementById('description').textContent = song.description;
                
                // Update nuevo desktop player
                document.getElementById('desktopMiniAlbum').src = song.albumArt;
                document.getElementById('desktopMiniTitle').textContent = song.title;
                document.getElementById('desktopMiniArtist').textContent = song.artist;
                
                // Mostrar el desktop player
                document.getElementById('desktopPlayerBar').style.display = 'flex';
                
                // Load y auto-play
                audio.src = song.audioSrc;
                audio.load();
                
                renderSongList();
                
                // Auto-play
                playAudio();
            }
        }

        function playAudio() {
            if (currentSongIndex !== null) {
                audio.play().then(() => {
                    isPlaying = true;
                    document.getElementById('desktopPlayBtn').innerHTML = '⏸';
                }).catch(error => {
                    console.error('Error playing audio:', error);
                });
            }
        }

        function pauseAudio() {
            audio.pause();
            isPlaying = false;
            document.getElementById('desktopPlayBtn').innerHTML = '▶';
        }

        function togglePlayPause() {
            if (currentSongIndex === null && musicLibrary.length > 0) {
                selectSong(0);
            }
            
            if (isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        }

        function nextSong() {
            if (musicLibrary.length === 0) return;
            const nextIndex = (currentSongIndex + 1) % musicLibrary.length;
            selectSong(nextIndex);
        }

        function previousSong() {
            if (musicLibrary.length === 0) return;
            const prevIndex = currentSongIndex === 0 ? musicLibrary.length - 1 : currentSongIndex - 1;
            selectSong(prevIndex);
        }

        function seekTo(event) {
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            const newTime = percent * audio.duration;
            
            if (!isNaN(newTime)) {
                audio.currentTime = newTime;
            }
        }

        function setVolume(event) {
            const volumeSlider = event.currentTarget;
            const rect = volumeSlider.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            
            audio.volume = Math.max(0, Math.min(1, percent));
            document.getElementById('volumeFill').style.width = (percent * 100) + '%';
        }

        function toggleMute() {
            audio.muted = !audio.muted;
            document.querySelector('.volume-btn').textContent = audio.muted ? '🔇' : '🔊';
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // View switching
        function showView(view) {
            console.log('Switching to view:', view);
            if (view === 'music') {
                musicView.style.display = 'block';
                chatView.style.display = 'none';
            } else if (view === 'chat') {
                musicView.style.display = 'none';
                chatView.style.display = 'flex';
            }

            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            if (view === 'music') {
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (view === 'chat') {
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
            }
        }

        // Audio event listeners
        audio.addEventListener('timeupdate', () => {
            if (audio.duration) {
                const progress = (audio.currentTime / audio.duration) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('desktopProgressFill').style.width = progress + '%';
                
                document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
                document.getElementById('desktopCurrentTime').textContent = formatTime(audio.currentTime);
            }
        });

        audio.addEventListener('loadedmetadata', () => {
            if (currentSongIndex !== null) {
                const song = musicLibrary[currentSongIndex];
                song.duration = formatTime(audio.duration);
                document.getElementById('duration').textContent = song.duration;
                document.getElementById('desktopDuration').textContent = song.duration;
                renderSongList();
            }
        });

        audio.addEventListener('ended', () => {
            nextSong();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', async () => {
            if (currentUser) {
                await supabaseClient
                    .from('users')
                    .update({ is_online: false, last_seen: new Date() })
                    .eq('id', currentUser.id);
            }
            
            if (messagesSubscription) messagesSubscription.unsubscribe();
            if (usersSubscription) usersSubscription.unsubscribe();
        });

        // Test functions for debugging
        window.testChat = function() {
            console.log('=== CHAT FUNCTIONALITY TEST ===');
            console.log('Current user:', currentUser);
            console.log('Message input element:', messageInput);
            console.log('Input value:', messageInput ? messageInput.value : 'INPUT NOT FOUND');
            console.log('Supabase client:', supabaseClient);
            
            if (!currentUser) {
                console.error('ERROR: No user logged in');
                return false;
            }
            
            if (!messageInput) {
                console.error('ERROR: Message input element not found');
                return false;
            }
            
            console.log('Basic test SUCCESSFUL');
            return true;
        };
        
        window.sendTestMessage = function() {
            console.log('Sending test message...');
            messageInput.value = 'Test message from console';
            sendMessage();
        };

        // Debug for Supabase
        console.log('Verifying Supabase configuration...');
        console.log('SUPABASE_URL:', SUPABASE_URL);
        console.log('SUPABASE_ANON_KEY exists:', !!SUPABASE_ANON_KEY);
        
        // Test Supabase connection
        async function testSupabaseConnection() {
            try {
                console.log('Testing Supabase connection...');
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    console.error('Supabase connection test failed:', error);
                    alert('Database connection failed. Please check your Supabase configuration.');
                } else {
                    console.log('Supabase connection successful!');
                }
            } catch (error) {
                console.error('Supabase test error:', error);
                alert('Please make sure to replace SUPABASE_URL and SUPABASE_ANON_KEY with your actual Supabase credentials.');
            }
        }

        // Test connection on load if credentials are provided
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
            testSupabaseConnection();
        } else {
            console.warn('Please replace the Supabase credentials in the code!');
            alert('Please replace SUPABASE_URL and SUPABASE_ANON_KEY with your actual Supabase credentials in the code.');
        }

        console.log('MusicPic initialized successfully!');
        console.log('Debug functions available: testChat(), sendTestMessage()');
        console.log('Loading music from GitHub repository:', GITHUB_REPO);
    </script>


</body>
</html>